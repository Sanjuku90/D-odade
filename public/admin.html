<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuestInvest - Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <header>
      <div class="container">
        <h1 class="logo">QuestInvest Admin</h1>
        <nav id="nav-links"></nav>
      </div>
    </header>

    <main class="container">
      <div id="admin-login" class="section">
        <div class="auth-container">
          <form id="admin-login-form" class="auth-form">
            <h2>Connexion Admin</h2>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="email" required>
            </div>
            <div class="form-group">
              <label>Mot de passe</label>
              <input type="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Se connecter</button>
            <p class="error-msg" id="admin-login-error"></p>
          </form>
        </div>
      </div>

      <div id="admin-dashboard" class="section hidden">
        <h2 class="admin-title">Gestion des Dépôts</h2>
        
        <div class="admin-filters">
          <button class="filter-btn active" data-filter="all">Tous</button>
          <button class="filter-btn" data-filter="pending">En attente</button>
          <button class="filter-btn" data-filter="confirmed">Confirmés</button>
          <button class="filter-btn" data-filter="rejected">Rejetés</button>
        </div>

        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Utilisateur</th>
                <th>Montant</th>
                <th>Hash Transaction</th>
                <th>Date</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="deposits-table"></tbody>
          </table>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2024 QuestInvest - Panel Admin</p>
      </div>
    </footer>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    let currentFilter = 'all';
    let allDeposits = [];

    document.addEventListener('DOMContentLoaded', () => {
      checkAdminAuth();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
          email: formData.get('email'),
          password: formData.get('password')
        };

        try {
          const res = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          if (res.ok) {
            showAdminDashboard();
          } else {
            document.getElementById('admin-login-error').textContent = result.error;
          }
        } catch (err) {
          document.getElementById('admin-login-error').textContent = 'Erreur de connexion';
        }
      });

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderDeposits();
        });
      });
    }

    async function checkAdminAuth() {
      try {
        const res = await fetch('/api/admin/check');
        const data = await res.json();
        if (data.isAdmin) {
          showAdminDashboard();
        } else {
          showAdminLogin();
        }
      } catch (err) {
        showAdminLogin();
      }
    }

    function showAdminLogin() {
      document.getElementById('admin-login').classList.remove('hidden');
      document.getElementById('admin-dashboard').classList.add('hidden');
      document.getElementById('nav-links').innerHTML = '<a href="/" class="nav-link">Retour au site</a>';
    }

    function showAdminDashboard() {
      document.getElementById('admin-login').classList.add('hidden');
      document.getElementById('admin-dashboard').classList.remove('hidden');
      document.getElementById('nav-links').innerHTML = '<button onclick="adminLogout()">Déconnexion</button>';
      loadDeposits();
    }

    async function loadDeposits() {
      try {
        const res = await fetch('/api/admin/deposits');
        if (res.ok) {
          allDeposits = await res.json();
          renderDeposits();
        }
      } catch (err) {
        console.error('Error loading deposits');
      }
    }

    function renderDeposits() {
      const tbody = document.getElementById('deposits-table');
      let filtered = allDeposits;
      
      if (currentFilter !== 'all') {
        filtered = allDeposits.filter(d => d.status === currentFilter);
      }

      const statusLabels = {
        'pending': '<span class="status-badge pending">En attente</span>',
        'confirmed': '<span class="status-badge confirmed">Confirmé</span>',
        'rejected': '<span class="status-badge rejected">Rejeté</span>'
      };

      tbody.innerHTML = filtered.map(d => `
        <tr>
          <td>${d.id}</td>
          <td>${d.user_email}</td>
          <td>$${parseFloat(d.amount).toFixed(2)}</td>
          <td class="tx-hash">${d.tx_hash || '-'}</td>
          <td>${new Date(d.created_at).toLocaleDateString('fr-FR')}</td>
          <td>${statusLabels[d.status] || d.status}</td>
          <td>
            ${d.status === 'pending' ? `
              <button class="btn btn-approve" onclick="approveDeposit(${d.id})">Approuver</button>
              <button class="btn btn-reject" onclick="rejectDeposit(${d.id})">Rejeter</button>
            ` : '-'}
          </td>
        </tr>
      `).join('');

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Aucun dépôt</td></tr>';
      }
    }

    async function approveDeposit(id) {
      if (!confirm('Confirmer l\'approbation de ce dépôt?')) return;
      
      try {
        const res = await fetch(`/api/admin/deposits/${id}/approve`, { method: 'POST' });
        const result = await res.json();
        if (res.ok) {
          showToast('Dépôt approuvé!', 'success');
          loadDeposits();
        } else {
          showToast(result.error, 'error');
        }
      } catch (err) {
        showToast('Erreur lors de l\'approbation', 'error');
      }
    }

    async function rejectDeposit(id) {
      if (!confirm('Confirmer le rejet de ce dépôt?')) return;
      
      try {
        const res = await fetch(`/api/admin/deposits/${id}/reject`, { method: 'POST' });
        const result = await res.json();
        if (res.ok) {
          showToast('Dépôt rejeté', 'success');
          loadDeposits();
        } else {
          showToast(result.error, 'error');
        }
      } catch (err) {
        showToast('Erreur lors du rejet', 'error');
      }
    }

    async function adminLogout() {
      try {
        await fetch('/api/admin/logout', { method: 'POST' });
        showAdminLogin();
      } catch (err) {
        console.error('Error logging out');
      }
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.remove('hidden');
      
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
  </script>
</body>
</html>
